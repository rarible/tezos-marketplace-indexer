spec_version: 1.2

datasources:
  tzkt:
    kind: tzkt
    url: ${TZKT_URL:-https://api.tzkt.io}
    http:
      connection_timeout: 60
  metadata:
    kind: metadata
    url: https://metadata.dipdup.net
    network: mainnet
  ipfs:
    kind: ipfs
    url: https://ipfs.io/ipfs

contracts:
  tzprofile_old:
    address: KT1KsmdYxuJHCMqLRX1PH7JJeXvXaMeicEa7
    typename: tzprofile
  tzprofile:
    address: KT1G6jaUQkRcxJcnrNLjCTn7xgD686PM2mEd
    typename: tzprofile
  tezos_domains_registry:
    address: KT1GBZmSxmnKJXGMdMLbugPfLyUPmuLSMwKS
    typename: tezos_domains_registry

templates:
  tzprofiles:
    kind: operation
    datasource: tzkt
    contracts:
      - <contract>
    types:
      - transaction
      - origination
    handlers:
      - callback: on_tzprofile_origination
        pattern:
          - type: origination
            originated_contract: <contract>
      - callback: on_tzprofile_update
        pattern:
          - destination: <contract>
            entrypoint: default
  tezos_domains_big_map:
    kind: big_map
    datasource: <datasource>
    skip_history: once
    handlers:
      - callback: on_tezos_domains_update_records
        contract: <name_registry>
        path: store.records

indexes:
  tzprofiles_originations:
    kind: operation
    datasource: tzkt
    types:
      - origination
    handlers:
       - callback: on_tzprofile_factory_origination
         pattern:
           - type: origination
             similar_to: tzprofile
       - callback: on_tzprofile_factory_origination
         pattern:
           - type: origination
             similar_to: tzprofile_old
  tezos_domains_big_map_mainnet:
    template: tezos_domains_big_map
    values:
      datasource: tzkt
      name_registry: tezos_domains_registry

hooks:
  process_missing_metadata_for_token:
    callback: process_missing_metadata_for_token
    atomic: False
  process_missing_metadata_for_collection:
    callback: process_missing_metadata_for_collection
    atomic: False

jobs:
  process_missing_metadata_for_token:
    hook: process_missing_metadata_for_token
    crontab: "* * * * *"
  process_missing_metadata_for_collection:
    hook: process_missing_metadata_for_collection
    crontab: "* * * * *"

advanced:
  rollback_depth: 2
  early_realtime: True
  metadata_interface: True
  merge_subscriptions: True
  reindex:
    manual: wipe
    migration: exception
    rollback: ignore
    config_modified: ignore
    schema_modified: ignore

custom:
  enabled: ${KAFKA_ENABLED:-false}
  kafka_address: ${KAFKA_ADDRESS:-kafka:9092}
  client_id: dipdup-rarible-${APPLICATION_ENVIRONMENT:-mainnet}-producer
  kafka_security_protocol: ${KAFKA_SECURITY_PROTOCOL:-SASL_PLAINTEXT}
  sasl:
    mechanism: ${KAFKA_SASL_MECHANISM:-PLAIN}
    username: ${KAFKA_USERNAME:-rarible}
    password: ${KAFKA_PASSWORD:-changeme}
  run_fix_jobs: False